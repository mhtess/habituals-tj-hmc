// time webppl priors-2.wppl --require mht --require habutils

var fpath = "data/"
var fpath2 = "data/"

var existData = mht.readCSV(fpath+"prior2-existence.csv").data
// var waitData = mht.readCSV(fpath+"prior2-logWait.csv").data
var waitData = mht.readCSV(fpath+"prior2-timesper5yr.csv").data

// for expt 2, Figure 2
var tjData = mht.readCSV(fpath2+"tj-2-logtimes.csv").data
var df_tj = dataFrame(tjData.slice(0,tjData.length-1), 
						["n_times", "log_times"])

// expt 3, Figure 3
// var tjData = mht.readCSV(fpath2+"tj-3.csv").data
// var df_tj = dataFrame(tjData, ["n_instances","past_logfreq", "future_logfreq"])

var df_e0 = dataFrame(existData.slice(0,existData.length-1), ["val"])

var df_e = map(function(x){
	return _.extend(x, {
		avoided_endval: avoidEnds(x["val"])
	})
}, df_e0)

var df_w = dataFrame(waitData.slice(0,waitData.length-1), ["val", "logval"])

var items = _.uniq(_.pluck(df_tj, "habitual"))
// var items = ["wears socks"]
var genders = _.uniq(_.pluck(df_e, "gender"))
// console.log(tjData.slice(0,tjData.length-1))
// var prior_samples = 50000
// var prior_burn = prior_samples/2
// var incrOpts = {burn:prior_burn, verbose:false, verboseLag: prior_samples/4}

var shape_alpha = function(gamma,delta){return gamma * delta}
var shape_beta = function(gamma,delta){return (1-gamma) * delta}


var questions = ["Q1","Q2"]

var priorModel = function(){

	foreach(items, function(i){
		// console.log(i)

		var itemData_e = subset(df_e, "item", i)
		var itemData_w = subset(df_w, "item", i)
		// console.log(itemData_w)

		// foreach(questions, function(q){

			foreach(genders, function(gender){
				// console.log(gender)
				// if (q=="Q1") {

					var genderData_e = subset(itemData_e, "gender", gender)
					// console.log(genderData_e)

					// % of Americans question
					var g = uniform(0,1)
					var d = uniform(0,50)

					var shape_a = shape_alpha(g,d)
					var shape_b = shape_beta(g,d)
					// console.log(g)
					// console.log(d)
					// console.log(shape_a)
					// console.log(shape_b)
					// console.log(_.pluck(genderData_e, "val").length)

					// var scr = sum(map(function(d){
					// 	return  betaERP.score([shape_a,shape_b], d)
					// }, _.pluck(genderData_e, "val")))


					var scr = reduce(function(d, memo) {
						// console.log(d)
							    return memo + betaERP.score([shape_a,shape_b], d)
								}, 0, _.pluck(genderData_e, "avoided_endval"))

					// console.log(_.pluck(genderData_e, "val"))
					// console.log("q1" + scr)

					factor(scr)


					var predictiveExistence = beta(shape_a, shape_b)

					query.add([i,gender,"Q1"], predictiveExistence)

				// } else {
					// console.log(g)
					var genderData_w = subset(itemData_w, "gender", gender)
					// console.log(genderData_w)

					var mu = uniform(0,10)
					var sigma = uniform(0,10)
					// console.log(itemData_w)

					var scr2 = sum(map(function(d){
						return gaussianERP.score([mu, sigma], d)
					}, _.pluck(genderData_w, "logval")))
					// console.log("q2" + scr2)

					factor(scr2)

					query.add([i,gender,"Q2"], [mu, sigma])

				// }

			})

		// })

	})			
	return query
}



